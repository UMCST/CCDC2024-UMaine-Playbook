## Windows Anti-Malware
Forensics


**Type of Systems**: Windows servers and workstations
**Necessary Skills**: Use of Sysinternals tools: Process explorer, TCPView, Autoruns

**Complete Goal**: To detect, understand, and eliminate malicious files on a Windows workstation or server.

**Relevant Info**:  
  - Process Explorer is a more-sophisticated version of Task Manager. It allows the
user to view currently running processes and specific information about each process.
Using the information from Process Explorer, malicious processes can be traced to files,
and those files can be deleted.  
  - TCPView is GUI version of the netstat command. TCPView allows the user to view
current network connections and connection details. Using this information, the
user can identify malicious connections to red team hosts, which indicates either
red team compromise or malware communicating with a command and control host.  
  - Autoruns is used to view files that are executed at startup. Autoruns has a
malware scanning feature, similar to Process Explorer. Autoruns is useful in
detecting persistent malware that executes at boot.  

**Steps:**
**Part 1: Process Explorer**
1. Login to a Windows workstation or server.
2. Download the Sysinternals Suite from Microsoft: http://bit.ly/2y18z6v
3. Among the Sysinternals tools, run “Process Explorer” as Administrator.
4. Once Process Explorer is running, it must be configured to operate effectively.
First, enable file signature verification: “options” > enable “Verify Image Signatures”,
then sort by “Verified Signer”, look over unverified processes. Note that malicious
processes may be signed. Use the image signatures to give indications, but do not depend
on them completely.
5. Second Process Explorer configuration: “Options” > “VirusTotal.com” >
“Check VirusTotal.com” The Virustotal scanning option sends the file to around
60 antivirus providers and shows the number of providers who decided that the process
is malicious. E.G. 5/61 = five providers think the process is malicious.
- Purple processes are the most suspicious- they contain packed code which could
be malicious.
- Use ctrl-h to open handles, which are all the resources that a particular
process is using in memory. Handles can be useful because they provide additional
detail about a particular process.
6. If a suspicious process is found, the first thing to do is learn more about it,
  before deciding to get rid of it. Double click on the suspicious process. This opens
  the properties window, which displays information about the process. The key piece of
information is the “Path” field, which shows the path to the executable that is running
the process. The “Explore” button will open the path in File Explorer.
7. Another useful piece of information is in the “TCP/IP” tab of the properties window.
  This tab shows network connections that the process has opened.
8. Once all useful information about a process has been obtained, it can be terminated.
  First, open the executable location of the process, so that the file location is not
  lost. Then, in Process Explorer, right click on the process and kill it. If the process
  reappears, it is set to automatically restart. In this case, suspend the process. Once
  the process has been stopped, delete the executable file. Unless the file is extremely
  persistent, it should now be gone.

**Part 2: TCPView**
1. Among the Sysinternals tools, run “TCPView” as Administrator.
2. TCPView is a very simple tool, and does not require much configuration. The main
thing to do is to sort network connections to show the most useful connections first,
because servers typically have hundreds of inactive connections. For an initial view, the
best option is usually to sort by “State.” This will show waiting, established, and
listening connections at the top of the window. After this, it is usually best to sort
by sent bytes or received bytes. This will place the connections with the most activity
first.
3. Once relevant connections have been viewed, they can be analyzed to find malicious
activity. The first configuration that can be done is to toggle DNS resolution, to
show either hostnames or IP addresses, whichever makes more sense. To do this, open
“Options,” and toggle “Resolve Addresses”
4. Once a suspicious connection has been found, double click on it. This will show the
path to to executable that is running that connection, and will allow the user to end
that process.
5. To get detailed information about a process found in TCPView, the user can search for
it in Process Explorer. To do this, copy the file location from TCPView, open Process
Explorer, press _ctrl-F_ to search, paste the file location into the search, and the
process should come up.
6. Once a malicious connection is discovered and understood, it can be terminated. First,
kill the process using either TCPView or Process Explorer, then delete the executable file.

**Part 3: Autoruns**  
1. Among the Sysinternals tools, run “Autoruns” as Administrator.
2. The automatically-starting applications are listed on the left, with a checkbox.
Before searching through all the entries to pick out the malicious ones, there are
a couple settings that should be set to make the search easier.
3. Open “Options” > “Scan Options,” and select “Verify code signatures” and “Check
VirusTotal.com,” then select “Rescan.”
4. After rescanning, the results will indicate if the file signature is verified and
will show a virustotal report. Use these details as potential indicators of malware.
5. Note that the autorun entries cannot be ordered in any particular way. Scroll
through them and search for suspicious entries. Look for entries without photos,
non-verified file signatures, odd names, or VirusTotal indicators.
6. Once a suspicious entry has been located, right click on it and open “properties.”
This will show the file path, publisher, and signatures. To see if the process that was
started by that entry is running, open Process Explorer, then in Autoruns, right click on
the entry, and select “Process Explorer.”
7. After learning about a malicious Autoruns entry, use Process Explorer to kill the
process being run by the entry. Once the process has been killed, there are two ways to
disable the Autoruns entry. The first option is to uncheck the entry, which prevents the
program from starting next time. The second, more effective option, is to delete the
entry. This will remove the program from Autrouns’ entries, so it will never execute at
boot.














